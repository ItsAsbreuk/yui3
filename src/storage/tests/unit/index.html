<!doctype html>
<html>
<head>
    <title>storage</title>
    <script src="../../../../build/yui/yui.js"></script>
    <script src="js/tests.js"></script>
    <meta charset="utf-8" />
</head>
<body class="yui3-skin-sam">
<div id="logger"></div>

<script>
YUI({
    coverage: ['storage'],
    filter: (window.location.search.match(/[?&]filter=([^&]+)/) || [])[1] || 'raw'
}).use('test-console', 'test', 'storage' , 'module-tests', function(Y) {
    
    (new Y.Test.Console()).render('#logger');

    Y.Test.Runner.setName('storage');
    Y.Test.Runner.run();
});

YUI().use('promise', 'oop', function (Y) {
  
  var win = Y.config.win,
      indexedDB = win.indexedDB || win.webkitIndexedDB || win.mozIndexedDB ||
        win.oIndexedDB || win.msIndexedDB;
  
  function Database() {
    Database.superclass.constructor.apply(this, arguments);
  }
  Y.extend(Database, Y.Promise, {
    collection: function (name) {
      var promise = this;
      
      return new Storage.Collection(function (resolve, reject) {
        promise.then(function (db) {
          try {
          } catch (e) {
            reject(e);
          } finally {
            resolve(db);
          }
        }, reject);
      });
    }
  });
  
  function Storage(config) {
    config = config || {};
    var version = config.version || 1,
      collections = config.collections || [],
        request = indexedDB.open(config.name, version),
          deferreds = [],
            self = this,
              db;
    
    request.onupgradeneeded = function (e) {
      db = e.target.result;
      for (var i = 0, length = collections.length; i < length; i++) {
        if (!db.objectStoreNames.contains(collections[i])) {
          db.createObjectStore(collections[i]);
        }
      }
    };
    request.onsuccess = function (e) {
      db = e.target.result;
      resolve(db);
    };
    request.onfailure = function (e) {
      for (var i = 0, length = deferreds.length; i < length; i++) {
        
      }
    };
  }
  
  function Collection() {
    Collection.superclass.constructor.apply(this, arguments);
  }
  Y.extend(Collection, Y.Promise);
  Storage.Collection = Collection;
  
  Collection.defer = function () {
    
  };
  
  var storage = new Storage({
    name: 'foo',
    collections: ['foo']
  });
  var collection = storage.collection('foo');
  collection.then(function (db) {
    console.log(db);
  }, function (e) {
    console.error(e);
  });
  
});
</script>
</body>
</html>
